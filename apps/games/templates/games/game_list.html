{% extends "base.html" %}
{% load static %}
{% load game_extras %}

{% block content %}
<section class="section-spacing">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">All Games</h2>
            <span class="text-sm text-gray-400">{{ paginator.count }} games</span>
        </div>

        <div class="flex justify-start items-center mb-6 space-x-4">
            <form method="get" class="flex space-x-4 items-center">
                <label>
                    <select name="discounted" class="bg-dark-card text-white rounded px-3 py-1">
                        <option value="" {% if not request.GET.discounted %}selected{% endif %}>All</option>
                        <option value="true" {% if request.GET.discounted == "true" %}selected{% endif %}>Discounted only</option>
                        <option value="false" {% if request.GET.discounted == "false" %}selected{% endif %}>Without discount</option>
                    </select>
                </label>
                <label>
                    <select name="release_year" class="bg-dark-card text-white rounded px-3 py-1">
                        <option value="" {% if not request.GET.release_year %}selected{% endif %}>All years</option>
                        <option value="2025" {% if request.GET.release_year == "2025" %}selected{% endif %}>2025</option>
                        <option value="2024" {% if request.GET.release_year == "2024" %}selected{% endif %}>2024</option>
                        <option value="2023" {% if request.GET.release_year == "2023" %}selected{% endif %}>2023</option>
                    </select>
                </label>
                <label>
                    <select name="ordering" class="bg-dark-card text-white rounded px-3 py-1">
                        <option value="-release_date" {% if request.GET.ordering == "-release_date" %}selected{% endif %}>Newest first</option>
                        <option value="release_date" {% if request.GET.ordering == "release_date" %}selected{% endif %}>Oldest first</option>
                        <option value="title" {% if request.GET.ordering == "title" %}selected{% endif %}>Title A–Z</option>
                        <option value="-title" {% if request.GET.ordering == "-title" %}selected{% endif %}> Title Z–A</option>
                        <option value="discount" {% if request.GET.ordering == "discount" %}selected{% endif %}>Biggest discount</option>
                    </select>
                </label>
                <button type="submit" class="bg-accent text-dark-bg rounded px-4 py-1 font-semibold hover:bg-accent-dark transition">Apply</button>
            </form>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-5">
            {% for game in game_list %}
            <div class="game-card bg-dark-card border border-dark-border rounded-lg overflow-hidden hover:border-accent transition-all group flex flex-col h-full">
                <a href="{% url 'game_detail' game.pk %}" class="block flex flex-col h-full">
                    <div class="aspect-w-1 aspect-h-1 bg-gray-700 relative">
                        {% with game.prices.first as price %}
                            {% if price and price.discount_percentage %}
                                <div class="discount-badge">-{{ price.discount_percentage|floatformat:0 }}%</div>
                            {% endif %}
                        {% endwith %}
                        {% with game.images.all|best_image as img %}
                            {% if img %}
                                <img src="{{ img }}" alt="{{ game.title }}" class="object-cover">
                            {% else %}
                                <div class="absolute inset-0 flex items-center justify-center bg-gray-700">
                                    <svg class="w-10 h-10 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                              d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                </div>
                            {% endif %}
                        {% endwith %}
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all"></div>
                    </div>
                    <div class="p-3 flex flex-col h-full">
                        <h3 class="font-semibold text-white group-hover:text-accent transition-colors text-sm mb-1 line-clamp-2">{{ game.title }}</h3>
                        {% if game.short_description or game.description %}
                        <p class="text-gray-400 text-xs line-clamp-3">
                            {% if game.short_description %}
                                {{ game.short_description|truncatewords:20 }}
                            {% else %}
                                {{ game.description|truncatewords:20 }}
                            {% endif %}
                        </p>
                        {% endif %}
                    </div>
                </a>
            </div>
            {% empty %}
            <p class="text-gray-400 col-span-full">No games found.</p>
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if is_paginated %}
        <div class="mt-8 flex justify-center space-x-2">
            {% if page_obj.has_previous %}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1" class="px-4 py-2 bg-dark-card text-white rounded hover:bg-accent transition" aria-label="First page">
                <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <mask id="mask0_39_14" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="25" height="25">
                    <rect x="0.832455" y="0.761597" width="24" height="24" fill="#D9D9D9"/>
                    </mask>
                    <g mask="url(#mask0_39_14)">
                    <path d="M4.83245 18.7616H2.83245V6.7616H4.83245V18.7616ZM12.8325 18.7616L6.83245 12.7616L12.8325 6.7616L14.2325 8.1616L10.6575 11.7616H22.8325V13.7616H10.6575L14.2575 17.3616L12.8325 18.7616Z" fill="white"/>
                    </g>
                </svg>

            </a>
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="px-4 py-2 bg-dark-card text-white rounded hover:bg-accent transition" aria-label="Previous page">
                <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <mask id="mask0_38_8" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="25" height="25">
                    <rect x="24.8325" y="24.7616" width="24" height="24" transform="rotate(-180 24.8325 24.7616)" fill="#D9D9D9"/>
                    </mask>
                    <g mask="url(#mask0_38_8)">
                    <path d="M8.65745 11.7616L20.8325 11.7616V13.7616L8.65745 13.7616L14.2575 19.3616L12.8325 20.7616L4.83245 12.7616L12.8325 4.7616L14.2575 6.1616L8.65745 11.7616Z" fill="white"/>
                    </g>
                </svg>
            </a>
            {% endif %}

            {% for num in paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="px-4 py-2 bg-accent text-dark-bg rounded font-semibold">{{ num }}</span>
                {% elif num > page_obj.number|add:-3 and num < page_obj.number|add:3 %}
                    <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}" class="px-4 py-2 bg-dark-card text-white rounded hover:bg-accent transition">{{ num }}</a>
                {% endif %}

            {% endfor %}

            {% if page_obj.has_next %}
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="px-4 py-2 bg-dark-card text-white rounded hover:bg-accent transition" aria-label="Next page">
                <svg width="25" height="25" viewBox="0 0 25 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <mask id="mask0_38_8" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="25" height="25">
                    <rect x="0.832455" y="0.761597" width="24" height="24" fill="#D9D9D9"/>
                    </mask>
                    <g mask="url(#mask0_38_8)">
                    <path d="M17.0075 13.7616H4.83245V11.7616H17.0075L11.4075 6.1616L12.8325 4.7616L20.8325 12.7616L12.8325 20.7616L11.4075 19.3616L17.0075 13.7616Z" fill="white"/>
                    </g>
                </svg>
            </a>
            <a href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}" class="px-4 py-2 bg-dark-card text-white rounded hover:bg-accent transition" aria-label="Next page">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <mask id="mask0_39_20" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="0" y="0" width="24" height="24">
                    <rect width="24" height="24" fill="#D9D9D9"/>
                    </mask>
                    <g mask="url(#mask0_39_20)">
                    <path d="M20 18V6H22V18H20ZM12 18L10.575 16.6L14.175 13H2V11H14.175L10.6 7.4L12 6L18 12L12 18Z" fill="white"/>
                    </g>
                </svg>

            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}